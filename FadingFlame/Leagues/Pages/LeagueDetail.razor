@page "/league/{leagueId?}"
@using MongoDB.Bson
@using FadingFlame.Leagues
@using FadingFlame.Players
@using FadingFlame.Admin
@using FadingFlame.Lists
@using FadingFlame.Matchups

@inject NavigationManager _navigation
@inject LoggedInUserState _loggedInUserState


@if (_league == null)
{
    <p>
        <em>Loading...</em>
    </p>
}
else
{
    <div>
        <h1>@_league.DivisionId @_league.Name</h1>
        <hr class="my-4">
    </div>
    <table class="table">
        <thead>
        <tr>
            <th>Name</th>
            <th>Faction</th>
            <th>Battle Points</th>
            <th>Victory Points</th>
            <th>Penalty Points</th>
            <th>Matches</th>
        </tr>
        </thead>
        <tbody class="league">
        @foreach (var item in _league.Players.Select((value, index) => new { value, index }))
        {
            <tr @onclick="() => GoToPlayer(item.value.Id)" class="cursor">
                <td>@GetName(item.value.Id)</td>
                <td>@GetRace(item.value.Id)</td>
                <td>@item.value.BattlePoints</td>
                <td>@item.value.VictoryPoints</td>
                <td @onclick:stopPropagation="true">
                    @if (_loggedInUserState.UserIsAdmin)
                    {
                        <div style="display: flex; flex-direction: row; max-width: 400px">
                            @if (item.value.Id == ObjectId.Empty)
                            {
                                <select class="form-select" @bind="_selectedNewPlayerIdRaw" style="max-width: 200px">
                                    <option selected value="@ObjectId.Empty.ToString()">Select player</option>
                                    @foreach (var player in _playersNotInLeagues)
                                    {
                                        <option value="@player.Id.ToString()">@player.DisplayName / @player.DiscordTag</option>
                                    }
                                </select>
                                <button @onclick="() => AddToLeague(_selectedNewPlayerIdRaw)" disabled="@_loadingAdmin" class="btn btn-danger ms-1">
                                    @if (_loadingAdmin)
                                    {
                                        <span class="spinner-border spinner-border-sm mr-1"></span>
                                    }
                                    <span class="oi oi-shield me-2" aria-hidden="true"></span>Add
                                </button>
                            }
                            else
                            {
                                <EditForm OnSubmit="() => OnSubmitPenalty(_penalties[item.index])" Model="@_penalties[item.index]">
                                <DataAnnotationsValidator/>
                                <div style="display: flex; flex-direction: row;">
                                     <div class="form-group" style="max-width: 5rem; margin-bottom: 0!important;">
                                         <InputNumber @bind-Value="_penalties[item.index].PenaltyPoints" class="form-control"/>
                                         <ValidationMessage For="@(() => _penalties[item.index].PenaltyPoints)"/>
                                     </div>
                                     <button @onclick:stopPropagation="false" disabled="@_loadingAdmin" class="btn btn-danger ms-1">
                                         @if (_loadingAdmin)
                                         {
                                             <span class="spinner-border spinner-border-sm mr-1"></span>
                                         }
                                         <span class="oi oi-shield me-2" aria-hidden="true"></span>Save
                                     </button>
                                </div>
                                </EditForm>
                                <button @onclick="() => RemoveFromLeague(item.value.Id)" disabled="@_loadingAdmin" class="btn btn-danger ms-1">
                                    @if (_loadingAdmin)
                                    {
                                        <span class="spinner-border spinner-border-sm mr-1"></span>
                                    }
                                    <span class="oi oi-shield me-2" aria-hidden="true"></span>Remove
                                </button>
                            }
                        </div>
                    }
                    else
                    {
                        @(_penalties[item.index].PenaltyPoints)
                    }
                </td>
                <td>@item.value.GamesCount</td>
            </tr>
        }
        </tbody>
    </table>    
    
    
    <div>
        <h2>Gamedays</h2>
        <hr class="my-4">
    </div>
    
    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
        @foreach (var gameDay in _league.GameDays.Select((value, index) => new { value, index }))
        {
            <li class="nav-item" role="presentation">
                @if (_activeDay == gameDay.index)
                {
                    <button
                        class="nav-link active"
                        id="pills-home-tab"
                        data-bs-toggle="pill"
                        data-bs-target="#pills-home"
                        type="button"
                        role="tab"
                        aria-controls="pills-home"
                        aria-selected="true"
                        @onclick="() => SelectGameDay(gameDay.index)"
                    >
                        @(gameDay.index + 1)
                    </button>
                }
                else
                {
                    <button
                        class="nav-link"
                        id="pills-home-tab"
                        data-bs-toggle="pill"
                        data-bs-target="#pills-home"
                        type="button"
                        role="tab"
                        aria-controls="pills-home"
                        aria-selected="true"
                        @onclick="() => SelectGameDay(gameDay.index)"
                    >
                        @(gameDay.index + 1)
                    </button>
                }
            </li>
        }
    </ul>
    <div class="tab-content" id="pills-tabContent">
        @foreach (var gameDay in _league.GameDays.Select((value, index) => new {value, index}))
        {
            @if (_activeDay == gameDay.index)
            {
                <div class="lead mb-3">@gameDay.value.StartDate.ToMyDate() - @gameDay.value.EndDate.ToMyDate()  —  @gameDay.value.Deployment.ToCamelCaseString() with @gameDay.value.SecondaryObjective.ToCamelCaseString()</div>
                <div class="tab-pane fade show active" id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab">
                    <div class="row row-cols-auto justify-content-around">
                        @foreach (var matchup in gameDay.value.Matchups)
                        {
                            <div class="col pb-4" >
                                <div class="@GetClasses(matchup)" @onclick="() => GoToMatch(matchup)" style="width: 24rem;">
                                    <div class="card-header">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h5 class="mb-1">@(GetName(matchup.Player1)) vs @(GetName(matchup.Player2))</h5>
                                            <small>@matchup.Result?.RecordedAt.ToMyDate()</small>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        @if (matchup.Result != null)
                                        {
                                            <p class="mb-1">@matchup.Result.Player1.BattlePoints : @matchup.Result.Player2.BattlePoints</p>
                                            <small>@GetOriginalPointsString(matchup.Result)</small>
                                        }
                                        else
                                        {
                                            <p class="mb-1">not reported yet</p>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="tab-pane fade" id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab">
                </div>
            }
        }
    </div>
}

@inject ILeagueRepository _leagueRepository
@inject IPlayerRepository _playerRepository

@code {
    [Parameter]
    public string LeagueId { get; set; }
    
    private League _league;
    private int _activeDay;
    private bool _loadingAdmin;
    private string _selectedNewPlayerIdRaw = ObjectId.Empty.ToString();
    private List<Player> _playersNotInLeagues = new();
    private List<Player> _playersInLeague = new();
    private List<PenaltyModel> _penalties = new();

    protected override void OnInitialized()
    {
        _loggedInUserState.UserLoggedIn += (_, _) => StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        if (ObjectId.TryParse(LeagueId, out var parsed))
        {
            _league = await _leagueRepository.Load(parsed);
            _penalties = MapPenalties(_league);
            _playersInLeague = await _playerRepository.LoadForLeague(_league.Players.Select(p => p.Id).ToList(), _league.Season);
            _playersNotInLeagues = (await _playerRepository.LoadAll()).OrderBy(p => p.DisplayName).ToList();
            var now = DateTime.UtcNow;
            for (int i = 0; i < _league.GameDays.Count; i++)
            {
                if (now < _league.GameDays[i].EndDate)
                {
                    _activeDay = i;
                    break;
                }
            }
        }
    }

    private void GoToPlayer(ObjectId playerId)
    {
        _navigation.NavigateTo($"player/{playerId}");
    }

    private void SelectGameDay(int id)
    {
        _activeDay = id;
        StateHasChanged();
    }

    private void GoToMatch(Matchup matchup)
    {
        _navigation.NavigateTo($"match/{matchup.Id}?leagueId={_league.Id}");
    }

    private string GetSecondaryStringForPlayer1(SecondaryObjectiveState resultSecondaryObjective)
    {
        return resultSecondaryObjective == SecondaryObjectiveState.player1 ? "(+2nd obj.)" : "";
    }

    private string GetSecondaryStringForPlayer2(SecondaryObjectiveState resultSecondaryObjective)
    {
        return resultSecondaryObjective == SecondaryObjectiveState.player2 ? "(+2nd obj.)" : "";
    }

    private string GetClasses(Matchup matchup)
    {
        return UserIsOneOfThePlayers(matchup) ? "bg-light card cursor" : "card cursor";
    }

    private bool UserIsOneOfThePlayers(Matchup matchup)
    {
        return _loggedInUserState.LoggedInPlayer.Id == matchup.Player1 || _loggedInUserState.LoggedInPlayer.Id == matchup.Player2;
    }

    private string GetOriginalPointsString(MatchResult result)
    {
        return $"{result.Player1.VictoryPoints} {GetSecondaryStringForPlayer1(result.SecondaryObjective)} : {result.Player2.VictoryPoints} {GetSecondaryStringForPlayer2(result.SecondaryObjective)}";
    }

    private string GetName(ObjectId playerId)
    {
        return _playersInLeague.FirstOrDefault(p => p.Id == playerId)?.DisplayName;
    }
    
    private string GetRace(ObjectId playerId)
    {
        var player = _playersInLeague.FirstOrDefault(p => p.Id == playerId);
        if (player == null) return "";
        var factions = new List<Faction?> { player.ArmyCurrentSeason?.List1?.Faction, player?.ArmyCurrentSeason?.List2?.Faction }.Where(l => l != null).Distinct();
        return string.Join("/", factions.Select(f => f.Value.ToCamelCaseString()));
    }

    private void OnSubmitPenalty(PenaltyModel model)
    {
        _loadingAdmin = true;
        _league.PenaltyPointsForPlayer(model.PlayerId, model.PenaltyPoints);
        _penalties = MapPenalties(_league);
        _leagueRepository.Update(_league);
        _loadingAdmin = false;
    }

    private List<PenaltyModel> MapPenalties(League league)
    {
        return league.Players.Select(p => new PenaltyModel(p.Id, p.PenaltyPoints)).ToList();
    }

    private void RemoveFromLeague(ObjectId playerId)
    {
        _loadingAdmin = true;
        _league.RemoveFromLeague(playerId);
        _leagueRepository.Update(_league);
        StateHasChanged();
        _loadingAdmin = false;
    }
    
    private void AddToLeague(string selectedNewPlayerIdRaw)
    {
        _loadingAdmin = true;
        _league.ReplaceDummyPlayer(new ObjectId(selectedNewPlayerIdRaw));
        _leagueRepository.Update(_league);
        StateHasChanged();
        _loadingAdmin = false;
    }
}